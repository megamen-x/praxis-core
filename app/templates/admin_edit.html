<!-- app/templates/admin_edit.html -->
{% extends "base.html" %}
{% block content %}
<h1 class="mb-3 mono">Редактирование опроса</h1>

<div class="q-block mb-3">
  <div class="row g-2">
    <div class="col-12">
      <label class="form-label mono">Название</label>
      <input id="title" class="form-control brutal-input" type="text" value="{{ review.title }}">
    </div>
    <div class="col-12">
      <label class="form-label mono">Описание</label>
      <textarea id="description" class="form-control brutal-input" rows="3">{{ review.description or '' }}</textarea>
    </div>
    <div class="col-md-3">
      <label class="form-label mono">Анонимность</label>
      <select id="anonymity" class="form-select brutal-input">
        <option value="true" {% if review.anonymity %}selected{% endif %}>Вкл</option>
        <option value="false" {% if not review.anonymity %}selected{% endif %}>Выкл</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label mono">Старт</label>
      <input id="start_at" class="form-control brutal-input" type="datetime-local" value="{{ (review.start_at or '')|replace(' ', 'T') }}">
    </div>
    <div class="col-md-4">
      <label class="form-label mono">Дедлайн</label>
      <input id="end_at" class="form-control brutal-input" type="datetime-local" value="{{ (review.end_at or '')|replace(' ', 'T') }}">
    </div>
  </div>
  <div class="col-md-12">
    <div class="mt-3">
      <button id="btn-save-review" class="btn btn-brutal">Сохранить</button>
      <button id="btn-delete-review" class="btn btn-danger">Удалить</button>
    </div>
  </div>
</div>

<h3 class="mono">Вопросы</h3>
<div id="questions">
  {% for q in questions %}
  <div class="q-block" data-id="{{ q.question_id }}">
    <div class="mb-2 question_label">Вопрос №{{ q.position+1 }}</div>
    <input  class="form-control brutal-input mb-2 q-text" value="{{ q.question_text }}" rows="3">
    <div class="row g-2 align-items-center">
      <div class="col-md-4">
        <select class="form-select brutal-input q-type">
          <option value="text" {% if q.question_type=='text' %}selected{% endif %}>Текст (строка)</option>
          <option value="textarea" {% if q.question_type=='textarea' %}selected{% endif %}>Текст (абзац)</option>
          <option value="radio" {% if q.question_type=='radio' %}selected{% endif %}>Один из списка</option>
          <option value="checkbox" {% if q.question_type=='checkbox' %}selected{% endif %}>Несколько из списка</option>
        </select>
      </div>
      <div class="col-md-3 form-check-colmn">
        <div class="form-check">
          <input class="form-check-input q-req" type="checkbox" {% if q.is_required %}checked{% endif %}> 
          <label class="form-check-label">Обязательный</label> 
        </div>
      </div>
      <div class="col-md-1">
        <input class="form-control brutal-input q-pos" type="number" value="{{ q.position }}">
      </div>
    </div>
    <div class="answers-ui mt-2"></div>
    <div class="mt-2">
      <button class="btn btn-sm btn-brutal btn-update">Обновить</button>
      <button class="btn btn-sm btn-danger btn-del">Удалить</button>
    </div>
  </div>
  {% endfor %}
</div>

<div class="q-block">
  <h5 class="mono">Добавить вопрос</h5>
  <div id="new-questions"></div>
  <button id="btn-add-q" class="btn btn-secondary">Новый вопрос</button>
  <button id="btn-create" class="btn btn-brutal">Сохранить вопросы</button>
</div>
{% endblock %}

{% block scripts %}
<script>
  const token = "{{ token }}";
  const reviewId = "{{ review.review_id }}";
  const csrf = (document.cookie.match(/(?:^|; )admin_csrf=([^;]*)/)||[])[1] || '';
  function headers() {
    return { "Content-Type":"application/json", "X-CSRF-Token": decodeURIComponent(csrf) };
  }

  // Helpers for answers UI
  function clear(el){ while(el.firstChild) el.removeChild(el.firstChild); }
  function ensureInt(v, d){ const n = parseInt(v, 10); return Number.isFinite(n) ? n : d; }
  function slugify(s){ return (s||"").toString().toLowerCase().trim().replace(/\s+/g,'_').replace(/[^\w\-]+/g,'').slice(0,64) || 'opt'; }

  function renderAnswers(block, type, meta={}) {
    const ui = block.querySelector('.answers-ui');
    clear(ui);

    if (type === 'text') {
      const input = document.createElement('input');
      input.className = 'form-control brutal-input';
      input.type = 'text';
      input.placeholder = 'Пример ответа';
      input.disabled = true;
      ui.appendChild(input);
      return;
    }

    if (type === 'textarea') {
      const ta = document.createElement('textarea');
      ta.className = 'form-control brutal-input';
      ta.rows = 3;
      ta.placeholder = 'Пример ответа';
      ta.disabled = true;
      ui.appendChild(ta);
      return;
    }

    function addOptionRow(kind, labelText='') {
      const row = document.createElement('div');
      row.className = 'd-flex align-items-center gap-2 mb-2 ans-'+kind+'-row';
      const inp = document.createElement('input');
      inp.type = kind;
      inp.className = 'form-check-input';
      inp.disabled = true;
      const txt = document.createElement('input');
      txt.type = 'text';
      txt.className = 'form-control brutal-input ans-'+kind+'-label';
      txt.placeholder = 'Вариант ответа';
      txt.value = labelText || '';
      const del = document.createElement('button');
      del.type = 'button';
      del.className = 'btn btn-sm btn-outline-danger ans-del-row';
      del.textContent = '×';
      del.addEventListener('click', () => row.remove());
      row.append(inp, txt, del);
      return row;
    }

    if (type === 'radio' || type === 'checkbox') {
      const list = document.createElement('div');
      list.className = 'ans-'+type+'-list';
      // prefill options
      if (meta && Array.isArray(meta.options) && meta.options.length) {
        meta.options.forEach(o => list.appendChild(addOptionRow(type, o.label ?? o.value ?? '')));
      } else {
        list.appendChild(addOptionRow(type, ''));
      }
      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.className = 'btn btn-sm btn-secondary mt-1 ans-add-row';
      addBtn.textContent = '+ Добавить вариант';
      addBtn.addEventListener('click', () => list.appendChild(addOptionRow(type, '')));
      ui.append(list, addBtn);
      return;
    }
  }

  function collectOptions(block) {
    const type = block.querySelector('.q-type').value;
    if (type === 'radio' || type === 'checkbox') {
      const selector = type === 'radio' ? '.ans-radio-label' : '.ans-checkbox-label';
      const labels = Array.from(block.querySelectorAll(selector))
        .map(i => i.value.trim())
        .filter(Boolean);
      return labels.map((text, idx) => ({ option_text: text, position: idx }));
    }
    // для text/textarea — опций нет
    return null;
  }

  function setupExistingBlocks() {
    document.querySelectorAll('#questions .q-block').forEach(block => {
      const typeSel = block.querySelector('.q-type');
      let meta = {};
      try { meta = JSON.parse(block.getAttribute('data-meta') || '{}'); } catch(e){}
      renderAnswers(block, typeSel.value, meta);
      typeSel.addEventListener('change', () => renderAnswers(block, typeSel.value, {}));

      // bind update
      block.querySelector('.btn-update').addEventListener('click', async () => {
        const id = block.dataset.id;
        const typeSel = block.querySelector('.q-type');
        const opts = collectOptions(block);

        const payload = {
          question_text: block.querySelector('.q-text').value,
          question_type: typeSel.value
        };
        if (opts !== null) payload.options = opts;

        const res = await fetch(`/api/questions/${id}?t=${token}&review_id=${reviewId}`, {
          method:'PATCH',
          headers: headers(),
          body: JSON.stringify(payload)
        });
        if (!res.ok) { alert('Ошибка обновления'); return; }
        location.reload();
      });

      // bind delete question
      block.querySelector('.btn-del').addEventListener('click', async () => {
        const id = block.dataset.id;
        if (!confirm('Удалить вопрос?')) return;
        const res = await fetch(`/api/questions/${id}?t=${token}&review_id=${reviewId}`, { method:'DELETE', headers: headers() });
        if (!res.ok) { alert('Ошибка удаления'); return; }
        location.reload();
      });
    });
  }

  function createNewBlock() {
    const el = document.createElement('div');
    el.className = 'q-block';
    el.innerHTML = `
      <input class="form-control brutal-input mb-2 q-text" placeholder="Текст вопроса">
      <div class="row g-2 align-items-center">
        <div class="col-md-4">
          <select class="form-select brutal-input q-type">
            <option value="text">Текст (строка)</option>
            <option value="textarea">Текст (абзац)</option>
            <option value="radio">Один из списка</option>
            <option value="checkbox">Несколько из списка</option>
          </select>
        </div>
        <div class="col-md-3 form-check">
          <input class="form-check-input q-req" type="checkbox"> <label class="form-check-label">Обязательный</label>
        </div>
        <div class="col-md-2">
          <input class="form-control brutal-input q-pos" type="number" value="0">
        </div>
      </div>
      <div class="answers-ui mt-2"></div>
    `;
    const typeSel = el.querySelector('.q-type');
    renderAnswers(el, typeSel.value, {});
    typeSel.addEventListener('change', () => renderAnswers(el, typeSel.value, {}));
    return el;
  }

  function collectNewItems() {
    return Array.from(document.querySelectorAll('#new-questions .q-block')).map(b => {
      const opts = collectOptions(b);
      const item = {
        question_text: b.querySelector('.q-text').value,
        question_type: b.querySelector('.q-type').value,
        is_required: b.querySelector('.q-req').checked,
        position: parseInt(b.querySelector('.q-pos').value || '0'),
      };
      if (opts !== null) item.options = opts; // поле не шлём для text/textarea
      return item;
    });
  }

  // Review save
  document.querySelector('#btn-save-review').addEventListener('click', async () => {
    const payload = {
      title: document.querySelector('#title').value,
      description: document.querySelector('#description').value,
      anonymity: document.querySelector('#anonymity').value === 'true',
      start_at: document.querySelector('#start_at').value || null,
      end_at: document.querySelector('#end_at').value || null,
    };
    const res = await fetch(`/api/reviews/${reviewId}?t=${token}`, { method:'PATCH', headers: headers(), body: JSON.stringify(payload) });
    if (!res.ok) alert('Ошибка сохранения');
  });

  // Review delete
  document.querySelector('#btn-delete-review').addEventListener('click', async () => {
    if (!confirm('Удалить весь опрос и все связанные анкеты/ответы? Действие необратимо.')) return;
    const res = await fetch(`/api/reviews/${reviewId}/questions/${id}?t=${token}`, {
      method:'DELETE', headers: headers()
    });
    if (!res.ok) { alert('Ошибка удаления'); return; }
    window.location.href = '/';
  });

  // Existing questions init
  setupExistingBlocks();

  // New questions
  const newWrap = document.querySelector('#new-questions');
  document.querySelector('#btn-add-q').addEventListener('click', () => {
    newWrap.appendChild(createNewBlock());
  });

  document.querySelector('#btn-create').addEventListener('click', async () => {
    const items = collectNewItems();
    if (!items.length) return;
    const res = await fetch(`/api/reviews/${reviewId}/questions?t=${token}`, { method:'POST', headers: headers(), body: JSON.stringify(items) });
    if (!res.ok) { alert('Ошибка создания'); return; }
    location.reload();
  });
</script>
{% endblock %}