{# 
Ожидаемые данные:
- mark_name: str
- employee_name: str
- summary: str
- strong_sides: list[ { "side_description": str, "proofs": list[str] } ]
- weak_sides:   list[ { "side_description": str, "proofs": list[str] } ]
- ambiguous_sides: list[ { "side_description": str } ]
- recommendations: list[ { "side_description": str, "brief_explanation": str, "recommendation": str } ]
- visualization_url: str | None  (URL картинки; необязательное)
- show_visualization: bool       (необязательное; по умолчанию true)
- quotes_layout: 'inline' | 'sublist'  (необязательное; по умолчанию 'inline')
#}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Итоговый отчет</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');

    html, body {
      font-family: 'Montserrat', Arial, sans-serif;
      font-size: 10pt;
      color: #000;
      margin: 0;
      padding: 24px;
    }

    /* Заголовки */
    h1 {
      font-size: 14pt;
      font-weight: 700;
      text-align: center;
      margin: 0 0 18pt 0;
    }
    h2 {
      font-size: 12pt;
      font-weight: 700;
      text-align: center;
      margin: 18pt 0 8pt 0;
    }

    /* Абзацы */
    p {
      text-align: justify;
      text-indent: 1.25cm;
      margin: 0 0 8pt 0;
      font-weight: 400;
      font-style: normal;
    }

    /* Единый стиль пунктов верхнего уровня */
    ul {
      list-style: none;
      padding-left: 0;
      margin: 6pt 0 12pt 0;
    }
    li {
      position: relative;
      padding-left: 1.2em;   /* место под маркер */
      text-align: justify;
      font-weight: 400;
      font-style: normal;
    }
    li::before {
      content: "–";          /* маркер верхнего уровня — короткое тире */
      position: absolute;
      left: 0;
    }

    /* Подсписки — сдвинуты левее и с маркером ✧ */
    ul.sublist {
      margin: 6pt 0 6pt 0;
      padding-left: 0;
    }
    ul.sublist li {
      padding-left: 1.2em;
    }
    ul.sublist li::before {
      content: "✧";
      font-size: 1.05em;
      position: absolute;
      left: 0;
    }

    /* Отступ 1.25 см только для ГЛАВНЫХ пунктов выбранных разделов */
    .root-indent {
      margin-left: 1.25cm;
    }

    /* Метка сноски у заголовка */
    .fn-ref {
      font-weight: 400;
      font-size: 0.9em;
      color: #666;
      vertical-align: super;
      margin-left: 4px;
      text-decoration: none;
    }
    .fn-ref a {
      color: inherit;
      text-decoration: none;
    }

    /* Сноска: рендерится в нижнем колонтитуле страницы "ambiguous" */
    .footnote-running {
      position: running(ambiguous-note);
      font-size: 8pt;
      text-align: justify;
      text-indent: 1.25cm;
      padding-top: 6pt;
      border-top: 0.5pt solid #000; /* тонкая чёрная линия на всю ширину */
      width: 100%;
    }

    /* Раздел "Спорные качества" печатается на именованной странице */
    .ambiguous-page { page: ambiguous; }

    /* Настройки страницы со сноской внизу */
    @page ambiguous {
      margin: 24pt;
      margin-bottom: 72pt;   /* резерв под нижний колонтитул со сноской */
      @bottom-center {
        content: element(ambiguous-note);
      }
    }

    /* Картинка визуализации */
    .viz img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 8pt auto 0 auto;
    }
  </style>
</head>
<body>

  {# Макрос: гарантирует единственный нужный завершающий знак #}
  {% macro ensure_ending(text, punctuation) -%}
    {%- set t = (text|string).strip() -%}
    {%- if t -%}
      {%- set last = t[-1:] -%}
      {%- if last in ['.', ',', ';', ':', '!', '?', '…'] -%}
        {{- t[:-1] -}}{{ punctuation }}
      {%- else -%}
        {{- t -}}{{ punctuation }}
      {%- endif -%}
    {%- endif -%}
  {%- endmacro %}

  <!-- Заголовок 1 уровня -->
  <h1>Итоговый отчет по оценке {{ mark_name }} сотрудника {{ employee_name }}</h1>

  <!-- Новый раздел: краткая характеристика -->
  <h2>Краткая характеристика сотрудника</h2>
  {% if summary %}
    <p>{{ summary }}</p>
  {% endif %}

  <!-- Сильные стороны -->
  <h2>Сильные стороны:</h2>
  {% if strong_sides %}
  <ul>
    {% for item in strong_sides %}
      <li>
        {% if (quotes_layout | default('inline')) == 'inline' %}
          <span class="li-text">
            {{ item.side_description }}{% if item.proofs and item.proofs|length > 0 %}:{% for q in item.proofs %} «{{ q }}»{% if not loop.last %};{% endif %}{% endfor %}{% endif -%}{{ ';' if not loop.last else '.' }}
          </span>
        {% else %}
          <span class="li-text">{{ item.side_description }}</span>
          {% if item.proofs and item.proofs|length > 0 %}
          <ul class="sublist">
            {% for q in item.proofs %}
              <li><span class="li-text">«{{ q }}»{% if not loop.last %};{% else %}.{% endif %}</span></li>
            {% endfor %}
          </ul>
          {% endif %}
          {# без завершающего знака у родительского пункта #}
        {% endif %}
      </li>
    {% endfor %}
  </ul>
  {% endif %}

  <!-- Точки роста -->
  <h2>Точки роста:</h2>
  {% if weak_sides %}
  <ul>
    {% for item in weak_sides %}
      <li>
        {% if (quotes_layout | default('inline')) == 'inline' %}
          <span class="li-text">
            {{ item.side_description }}{% if item.proofs and item.proofs|length > 0 %}:{% for q in item.proofs %} «{{ q }}»{% if not loop.last %};{% endif %}{% endfor %}{% endif -%}{{ ';' if not loop.last else '.' }}
          </span>
        {% else %}
          <span class="li-text">{{ item.side_description }}</span>
          {% if item.proofs and item.proofs|length > 0 %}
          <ul class="sublist">
            {% for q in item.proofs %}
              <li><span class="li-text">«{{ q }}»{% if not loop.last %};{% else %}.{% endif %}</span></li>
            {% endfor %}
          </ul>
          {% endif %}
          {# без завершающего знака у родительского пункта #}
        {% endif %}
      </li>
    {% endfor %}
  </ul>
  {% endif %}

  <!-- Спорные качества (сноска внизу ЭТОЙ страницы) -->
  <section class="ambiguous-page">
    <h2>Спорные качества<span class="fn-ref"><a href="#fn-ambiguous" title="См. сноску">¹</a></span>:</h2>

    {# running‑элемент: попадёт в нижний колонтитул страницы ambiguous #}
    <div id="fn-ambiguous" class="footnote-running">
      <p>
        Спорными качествами обозначаются те характеристики, которые были отмечены некоторыми респондентами
        как сильные качества, а несколькими — как точки роста.
      </p>
    </div>

    {% if ambiguous_sides %}
    <ul class="root-indent">
      {% for item in ambiguous_sides %}
        <li><span class="li-text">{{ item.side_description }}{{ ';' if not loop.last else '.' }}</span></li>
      {% endfor %}
    </ul>
    {% endif %}
  </section>

  <!-- Рекомендации по работе -->
  <h2>Рекомендации по работе:</h2>
  {% if recommendations %}
  <ul class="root-indent">
    {% for rec in recommendations %}
      <li>
        <span class="li-text">{{ rec.side_description }}</span>
        <ul class="sublist">
          <li><span class="li-text">Краткое описание: {{ ensure_ending(rec.brief_explanation, ';') }}</span></li>
          <li><span class="li-text">Советы по улучшению: {{ ensure_ending(rec.recommendation, '.') }}</span></li>
        </ul>
        {# у родительского пункта не ставим завершающий знак #}
      </li>
    {% endfor %}
  </ul>
  {% endif %}

  {# Визуализация: выводим ТОЛЬКО если есть URL и флаг не выключен #}
  {% if (show_visualization | default(true)) and visualization_url %}
    <h2>Визуализация оценки {{ mark_name }}</h2>
    <div class="viz">
      <img src="{{ visualization_url }}" alt="Визуализация оценки {{ mark_name }}">
    </div>
  {% endif %}

</body>
</html>